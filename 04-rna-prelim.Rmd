# RNA data: preliminary plots

Prior to doing any comparative analysis, we will look at the following plots to get an overview of the data.

```{r}
# Load any required files:
load("../anntotations/Rat_biomart_gene_annotations2.RData")
#load("../dds_normalised_data_newstar_RNAseqapril_2020-11-07_rm_outliers.RData")

```

## PCA plots

We can check the new PCA plots, and overlay parameters of interest including treatment, growth, tumor size, CD8 fraction, spatial distribution.

```{r vsd-corrected,eval=T, cache=T}
vsd2 <- vst(dds)
vsd2$MHEpCAMcut=cut(infoTableFinal$MHEpCAM, c(-1, median(infoTableFinal$MHEpCAM, na.rm = T), 1.1), c("low", "high"))
vsd2$knnEpCAMcut=cut(infoTableFinal$knnEpCAM, c(-1, median(infoTableFinal$knnEpCAM, na.rm = T), 1E7), c("low", "high"))
vsd2$IFEpCAMcut=cut(infoTableFinal$IFEpCAM, c(-1, median(infoTableFinal$IFEpCAM, na.rm = T), 1.1), c("low", "high"))
vsd2$CD8FracCut=cut(infoTableFinal$CD8Frac, c(-1, median(infoTableFinal$CD8Frac, na.rm = T), 1.1), c("low", "high"))

plotPCA(vsd2, c("Treatment"))+ggtitle("Treatment")
plotPCA(vsd2, c("Growth"))+ggtitle("Growth")
plotPCA(vsd2, "TumSize")+ggtitle("tumor size")
#plotPCA(vsd2, "CD8Frac")+ggtitle("CD8 Fraction")
plotPCA(vsd2, "CD8FracCut")+ggtitle("CD8 Fraction")
plotPCA(vsd2, "SpatialManual")+ggtitle("CD8 distribution")
plotPCA(vsd2, "MHEpCAMcut")+ggtitle("MH EpCAM")
plotPCA(vsd2, "IFEpCAMcut")+ggtitle("IF SMA")
plotPCA(vsd2, "knnEpCAMcut")+ggtitle("knn EpCAM")

```


In addition, we can look at the CD45 population and the distributions based on CD8 content and spatial infiltration

```{r}
# CD8 restricted/infil
plotPCA(vsd2[ , grep("CD45", colnames(vsd2))], "CD8FracCut")+ggtitle("CD8 content")
plotPCA(vsd2[ , grep("CD45", colnames(vsd2))], "IFEpCAMcut")+ggtitle("CD8-EpCAM Infiltrating Fraction")
plotPCA(vsd2[ , grep("CD45", colnames(vsd2))], "knnEpCAMcut")+ggtitle("CD8-EpCAM nearest neighbor distances")
plotPCA(vsd2[ , grep("CD45", colnames(vsd2))], "MHEpCAMcut")+ggtitle("CD8-EpCAM MH index")
```


## Expression patterns by cell type

Below, we check whether the different fractions are expressing expected markers 

The cell types are:

* Red: Cd45
* Epcam: green 
* DN:blue

```{r}
Xa=c(brewer.pal(3, "Reds"), brewer.pal(3, "Blues"), brewer.pal(3, "Greens"))

plotPCA(vsd[, which(vsd$Cohort%in%"Progression")], c("Growth", "Fraction"))+scale_color_manual(values=Xa[c( 3,9, 6,1, 7, 4, 2,8, 5)])+theme_bw()


vsd$Treatment2=ifelse(vsd$Treatment=="Vehicle", "none", "yes")
plotPCA(vsd[, which(vsd$Cohort%in%"Progression" & vsd$Fraction=="CD45")], c("Treatment2"))+scale_color_manual(values=c("orange", "#31A354"))+theme_bw()
plotPCA(vsd[, which(vsd$Cohort%in%"Progression" & vsd$Fraction=="DN")], c("Growth"))+scale_color_manual(values=c("orange", "#31A354"))+theme_bw()
plotPCA(vsd[, which(vsd$Cohort%in%"Progression" & vsd$Fraction=="CD45")], c("Growth"))+scale_color_manual(values=c("orange", "#31A354"))+theme_bw()
```

Reference Genes:

* purple: immune
* blue: epithelial
* green: stroma
* orange: myoepithelial
* red: endothelial

Below, we see that the CD45 cells separate from the Ep/DN populations have high expression of immune related genes including CD3, CD4, IFNG.

However, the DN/Ep fractions are more intermixed. The DN fraction has expression of keratins, as well as fibroblast markers (Acta1), and myeoepithelial markers (Tp63)

```{r}
## why doesnt this work???
Agenes=unlist(GeneListRat)

# Use the original desseq data,a nd then the limma data
x1=match(Agenes, rownames(assay(vsd)))
RatExpr2=assay(vsd)[na.omit(x1), which(vsd$Cohort=="Progression")]

RowSideCol=names(Agenes)[which(!is.na(x1))]
RowSideCol=substr(RowSideCol, 1, 3)

ColSideCol=sapply(strsplit(colnames(RatExpr2), "_"), function(x) x[length(x)])

colnames(RatExpr2)=paste(infoTableFinal$TumorIDnew[match(colnames(RatExpr2), rownames(infoTableFinal))],
                         infoTableFinal$Fraction[match(colnames(RatExpr2), rownames(infoTableFinal))])
#pdf("~/Desktop/FiguS3_celltype_markers_RNA.pdf", height = 10, width=14)

a1=heatmap.2(RatExpr2, col=RdBu[11:1], trace="none", RowSideColors = brewer.pal(6, "Set1")[factor(RowSideCol)], scale="row",  ColSideColors =brewer.pal(3, "Set1")[factor(ColSideCol)] )
 
 a1=heatmap.2(RatExpr2[, -grep("CD45", colnames(RatExpr2))], col=RdBu[11:1], trace="none", RowSideColors = brewer.pal(6, "Set1")[factor(RowSideCol)], scale="row",
              ColSideColors =brewer.pal(3, "Set1")[factor(ColSideCol[-grep("CD45", colnames(RatExpr2))])] )

#dev.off()


# plot the heatmap col-side bar
# ColBars=rbind(factor(infoTableFinal$Fraction[a1$colInd]), factor(infoTableFinal$Batch[a1$colInd]))
# image(t(ColBars), col=c(1:3), main="column index", yaxt="none", xaxt="none")
# axis(2, at=c(0, 1), labels=c("cell type", "batch"), las=2)
# par(oma=c(3, 0,0,0))
# a1=heatmap.2(RatExpr2[ ,grep("2[R|N]", colnames(RatExpr2))], col=RdBu[11:1], trace="none", RowSideColors = brewer.pal(6, "Set1")[factor(RowSideCol)], scale="row")

#dev.off()
```

