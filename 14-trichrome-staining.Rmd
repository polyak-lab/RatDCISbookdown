# Trichrome staining

Quantification of trichrome staining was performed in Qupath using the following steps:

* image is loaded as a "DAB" image
* using "gold standard" trichrome-stained images with good stroma and epithelial content, estimate the stain vectors
* The output matrix was: XXX
* Perform color deconvolution
* A pixel classifier was used to estimate trichrome content
* A pixel classifier was used to estimate tumor content

A snippet of the qupath script is shown below:

```{r, eval=F, echo=F}
# insert some text here



```

## Associations with cellular fraction (wsi)

```{r, height=6, eval=T}
# load the data
TrichromeData=read.xlsx("../data/trichrome-staining-result.xls", 1)
midx=match(TrichromeData$SampleID, gsub("_", "", Cdata$TumorID))

Cdata$Trichrome=NA
Cdata$Trichrome[na.omit(midx)]=TrichromeData$Percentage.Stroma[which(!is.na(midx))]

t2=WSIvalFracs[, match(rownames(df.Spatial), colnames(WSIvalFracs))]

df.Spatial=cbind(df.Spatial, t(t2))

#head(df.Spatial)

df.Spatial$Trichrome=NA
midx=match(TrichromeData$SampleID, rownames(df.Spatial))
df.Spatial$Trichrome[na.omit(midx)]=TrichromeData$Percentage.Stroma[-which(is.na(midx))]
# plot associations

n2=c("CD8", "EpCAM", "SMA", "Unclass", "EpCAM: SMA")

write.csv(df.Spatial, file="outputs/summary_spatial_information.csv")

head(df.Spatial)

pdf("~/Desktop/richrome-association-WSI-data-Calc2.pdf", width=6, height=5)

par(mfrow=c(2,3))
for (i in n2){
   a1=cor.test(df.Spatial$Trichrome, df.Spatial[ ,match(i, colnames(df.Spatial))], use="complete")
   n1=paste(i, "cor:", round(a1$estimate,1), "p:", round(a1$p.value,2))
   plot(df.Spatial$Trichrome, df.Spatial[ ,match(i, colnames(df.Spatial))], main=n1, xlab="Trichrome", ylab=i)
}

dev.off()
```

## Associations with growth and spatial patterns

```{r, fig.height=6}
# plot associations with growth
##
##

pdf("~/Desktop/Trichrome-association-clinicopathological-Calc2.pdf", width=8, height=8)

n2=c("GrowthRate", "MH.EpCAM", "IF.EpCAM", "knn.EpCAM")
n2
par(mfrow=c(2,2))
for (i in n2){
  a1=cor.test(df.Spatial$Trichrome, df.Spatial[ ,i], use="complete")
  n1=paste(i, "cor:", round(a1$estimate,1), "p:", round(a1$p.value,2))
  plot(df.Spatial$Trichrome, df.Spatial[ ,i], main=n1, xlab="Trichrome", ylab=i)
  text(df.Spatial$Trichrome, df.Spatial[ ,i], rownames(df.Spatial))
}

a1=wilcox.test(df.Spatial$Trichrome~df.Spatial$Growth)$p.val
boxplot(df.Spatial$Trichrome~df.Spatial$Growth, main=sprintf("Growth vs Trichrome p=%s", round(a1,2)))
boxplot(df.Spatial$Trichrome~df.Spatial$Treatment, main="Treatment vs Trichrome")

a1=wilcox.test(df.Spatial$Trichrome~df.Spatial$IF.EpCAMcut)$p.val
boxplot(df.Spatial$Trichrome~df.Spatial$IF.EpCAMcut, main=sprintf("Ep int. fraction %s", round(a1,2)))
a1=wilcox.test(df.Spatial$Trichrome~df.Spatial$CD8Fraccut)$p.val
boxplot(df.Spatial$Trichrome~df.Spatial$CD8Fraccut, main=sprintf("CD8 fraction vs Trichrome %s", round(a1,2)))

dev.off()
```